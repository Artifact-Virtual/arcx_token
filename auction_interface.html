<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCx Dutch Auction - Constitutional Intelligence</title>
    <link rel="stylesheet" href="css/arcx-universal.css">
</head>
<body>
    <!-- Immersive Background -->
    <div class="immersive-canvas">
        <div class="layer-1"></div>
        <div class="layer-2"></div>
        <div class="floating-elements">
            <!-- Floating particles will be added dynamically -->
        </div>
    </div>

    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">ARCx</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="auction_interface.html" class="active">Auction</a></li>
                <li><a href="airdrop_interface.html">Airdrop</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-container">
        <div class="container">
            <!-- Header -->
            <header class="text-center mb-xxl">
                <div class="badge mb-lg">Live Dutch Auction</div>
                <h1 class="hero-title mb-md">ARCx Auction</h1>
                <p class="text-large">Constitutional Intelligence Infrastructure Genesis</p>
            </header>
            
            <!-- Status Card -->
            <div class="card status-card mb-xl">
                <div class="card-title">System Status</div>
                <div id="systemStatus" class="status-value status-loading">LOADING...</div>
                <div id="systemMessage" class="text-small">Initializing interface...</div>
            </div>
            
            <!-- Main Grid -->
            <div class="grid grid-2 mb-xl">
                <!-- Current Price -->
                <div class="card">
                    <h2 class="card-title">Current Price</h2>
                    <div class="text-center">
                        <div id="currentPrice" class="status-value status-success mb-sm">...</div>
                        <div class="text-small mb-sm">ETH per ARCx</div>
                        <div class="badge badge-amber">Price declining over time</div>
                    </div>
                </div>
                
                <!-- Auction Stats -->
                <div class="card">
                    <h2 class="card-title">Auction Statistics</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div id="tokensAvailable" class="info-value">...</div>
                            <div class="info-label">Available</div>
                        </div>
                        <div class="info-item">
                            <div id="tokensSold" class="info-value">...</div>
                            <div class="info-label">Sold</div>
                        </div>
                        <div class="info-item">
                            <div id="totalRaised" class="info-value">...</div>
                            <div class="info-label">ETH Raised</div>
                        </div>
                        <div class="info-item">
                            <div id="timeRemaining" class="info-value">...</div>
                            <div class="info-label">Time Left</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Purchase Section -->
            <div class="card card-highlight mb-xl">
                <h2 class="card-title">Purchase Tokens</h2>
                
                <!-- Wallet Status -->
                <div class="wallet-section">
                    <div class="wallet-status">
                        <div class="wallet-info">
                            <div id="statusDot" class="status-dot"></div>
                            <div>
                                <div id="walletStatus">Not Connected</div>
                                <div id="walletAddress" class="wallet-address"></div>
                            </div>
                        </div>
                        <button id="connectWallet" class="button button-secondary">Connect Wallet</button>
                    </div>
                </div>
                
                <!-- Purchase Form -->
                <div id="purchaseForm">
                    <div class="input-group">
                        <label class="input-label">ETH Amount</label>
                        <input type="number" id="ethAmount" class="input-field" placeholder="0.1" step="0.001" min="0">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">ARCx Tokens (Estimated)</label>
                        <input type="text" id="arcxAmount" class="input-field" placeholder="0" readonly>
                    </div>
                    
                    <!-- Network Info -->
                    <div class="info-grid mb-lg">
                        <div class="info-item">
                            <div class="info-value text-small">Base L2</div>
                            <div class="info-label">Network</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value text-small">~$0.01</div>
                            <div class="info-label">Gas Fees</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value text-small">10,000</div>
                            <div class="info-label">Max Purchase</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value text-small text-mono">0x5Da5...836</div>
                            <div class="info-label">Contract</div>
                        </div>
                    </div>
                    
                    <button id="purchaseBtn" class="button full-width" disabled>
                        Connect Wallet to Purchase
                    </button>
                    
                    <div id="messageArea" class="message-area"></div>
                </div>
            </div>
            
            <!-- Contract Information -->
            <div class="card">
                <h3 class="card-title">Contract Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-value text-small text-mono">0x5Da5...836</div>
                        <div class="info-label">Auction Contract</div>
                    </div>
                    <div class="info-item">
                        <div class="info-value text-small text-mono">0xA409...244</div>
                        <div class="info-label">ARCx Token</div>
                    </div>
                    <div class="info-item">
                        <div class="info-value text-small">Base L2</div>
                        <div class="info-label">Network</div>
                    </div>
                    <div class="info-item">
                        <div class="info-value text-small">Verified</div>
                        <div class="info-label">Status</div>
                    </div>
                </div>
            </div>
            
            <!-- Debug Info -->
            <div class="debug-info">
                <div><strong>Debug Information:</strong></div>
                <div id="debugInfo">Starting initialization...</div>
            </div>
        </div>
    </div>

    <!-- Load ethers with failsafe -->
    <script>
        // Global variables
        window.auctionApp = {
            ethers: null,
            provider: null,
            signer: null,
            contract: null,
            isConnected: false,
            auctionData: {}
        };
        
        const AUCTION_ADDRESS = "0x5Da5F567553C8D4F12542Ba608F41626f77Aa836";
        const BASE_CHAIN_ID = 8453;
        const AUCTION_ABI = [
            "function getAuctionStatus() view returns (uint256 _currentPrice, uint256 _tokensSold, uint256 _tokensRemaining, uint256 _totalRaised, uint256 _timeRemaining, bool _isActive)",
            "function purchase() payable"
        ];
        
        // Debug logging
        function log(message) {
            console.log(message);
            const debugEl = document.getElementById('debugInfo');
            if (debugEl) {
                debugEl.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
            }
        }
        
        // Update status display
        function updateStatus(status, message, type = 'loading') {
            const statusEl = document.getElementById('systemStatus');
            const messageEl = document.getElementById('systemMessage');
            
            if (statusEl) {
                statusEl.textContent = status;
                statusEl.className = `status-value status-${type}`;
            }
            if (messageEl) {
                messageEl.textContent = message;
            }
        }
        
        // Load ethers.js with multiple fallbacks
        function loadEthers() {
            return new Promise((resolve, reject) => {
                const cdnList = [
                    'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js',
                    'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js'
                ];
                
                let currentIndex = 0;
                
                function tryNext() {
                    if (currentIndex >= cdnList.length) {
                        reject(new Error('All CDN attempts failed'));
                        return;
                    }
                    
                    log(`Trying ethers CDN ${currentIndex + 1}/${cdnList.length}: ${cdnList[currentIndex]}`);
                    
                    const script = document.createElement('script');
                    script.src = cdnList[currentIndex];
                    
                    script.onload = () => {
                        setTimeout(() => {
                            if (typeof ethers !== 'undefined') {
                                window.auctionApp.ethers = ethers;
                                log(`‚úÖ Ethers loaded successfully from CDN ${currentIndex + 1}`);
                                resolve(ethers);
                            } else {
                                log(`‚ö†Ô∏è CDN ${currentIndex + 1} loaded but ethers not available`);
                                currentIndex++;
                                tryNext();
                            }
                        }, 100);
                    };
                    
                    script.onerror = () => {
                        log(`‚ùå CDN ${currentIndex + 1} failed to load`);
                        currentIndex++;
                        tryNext();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryNext();
            });
        }
        
        // Load auction data
        async function loadAuctionData() {
            try {
                log('Loading auction data...');
                const provider = new window.auctionApp.ethers.providers.JsonRpcProvider('https://mainnet.base.org');
                const contract = new window.auctionApp.ethers.Contract(AUCTION_ADDRESS, AUCTION_ABI, provider);
                
                const status = await contract.getAuctionStatus();
                
                window.auctionApp.auctionData = {
                    currentPrice: status._currentPrice,
                    tokensSold: status._tokensSold,
                    tokensRemaining: status._tokensRemaining,
                    totalRaised: status._totalRaised,
                    timeRemaining: status._timeRemaining,
                    isActive: status._isActive
                };
                
                // Update UI
                const price = parseFloat(window.auctionApp.ethers.utils.formatEther(status._currentPrice)).toFixed(6);
                const available = parseInt(window.auctionApp.ethers.utils.formatEther(status._tokensRemaining)).toLocaleString();
                const sold = parseInt(window.auctionApp.ethers.utils.formatEther(status._tokensSold)).toLocaleString();
                const raised = parseFloat(window.auctionApp.ethers.utils.formatEther(status._totalRaised)).toFixed(2);
                const timeLeft = formatTime(status._timeRemaining.toNumber());
                
                document.getElementById('currentPrice').textContent = price;
                document.getElementById('tokensAvailable').textContent = available;
                document.getElementById('tokensSold').textContent = sold;
                document.getElementById('totalRaised').textContent = raised;
                document.getElementById('timeRemaining').textContent = timeLeft;
                
                log('‚úÖ Auction data loaded successfully');
                updateStatus('READY', 'Auction interface ready', 'success');
                
            } catch (error) {
                log('‚ùå Error loading auction data: ' + error.message);
                updateStatus('ERROR', 'Failed to load auction data', 'error');
                
                document.getElementById('currentPrice').textContent = 'Error';
                document.getElementById('tokensAvailable').textContent = 'Error';
                document.getElementById('tokensSold').textContent = 'Error';
                document.getElementById('totalRaised').textContent = 'Error';
                document.getElementById('timeRemaining').textContent = 'Error';
            }
        }
        
        // Format time helper
        function formatTime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }
        
        // Wallet connection
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask not installed');
                }
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Switch to Base
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x2105' }]
                    });
                } catch (error) {
                    if (error.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x2105',
                                chainName: 'Base',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: ['https://mainnet.base.org'],
                                blockExplorerUrls: ['https://basescan.org']
                            }]
                        });
                    }
                }
                
                window.auctionApp.provider = new window.auctionApp.ethers.providers.Web3Provider(window.ethereum);
                window.auctionApp.signer = window.auctionApp.provider.getSigner();
                
                const address = await window.auctionApp.signer.getAddress();
                
                document.getElementById('walletStatus').textContent = 'Connected';
                document.getElementById('walletAddress').textContent = `${address.slice(0, 8)}...${address.slice(-6)}`;
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('connectWallet').textContent = 'Disconnect';
                document.getElementById('purchaseBtn').disabled = false;
                document.getElementById('purchaseBtn').textContent = 'Purchase ARCx';
                
                window.auctionApp.isConnected = true;
                log('‚úÖ Wallet connected successfully');
                
                // Enable purchase functionality
                if (window.auctionApp.auctionData.isActive) {
                    showMessage('Wallet connected! You can now purchase ARCx tokens.', 'success');
                }
                
            } catch (error) {
                log('‚ùå Wallet connection failed: ' + error.message);
                showMessage('Failed to connect wallet: ' + error.message, 'error');
            }
        }
        
        // Show message
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => messageArea.innerHTML = '', 5000);
            }
        }
        
        // Handle purchase
        async function handlePurchase() {
            try {
                log('üî• Purchase button clicked!');
                
                if (!window.auctionApp.isConnected) {
                    log('‚ùå Wallet not connected');
                    showMessage('Please connect your wallet first', 'error');
                    return;
                }
                log('‚úÖ Wallet is connected');
                
                const ethAmount = document.getElementById('ethAmount').value;
                log(`üí∞ ETH Amount entered: ${ethAmount}`);
                
                if (!ethAmount || parseFloat(ethAmount) <= 0) {
                    log('‚ùå Invalid ETH amount');
                    showMessage('Please enter a valid ETH amount', 'error');
                    return;
                }
                log('‚úÖ ETH amount is valid');
                
                if (!window.auctionApp.auctionData.isActive) {
                    log('‚ùå Auction not active');
                    showMessage('Auction has ended', 'error');
                    return;
                }
                log('‚úÖ Auction is active');
                
                log('Starting purchase transaction...');
                showMessage('Initiating purchase...', 'info');
                
                // Create contract instance with signer
                log('üìù Creating contract instance...');
                const contract = new window.auctionApp.ethers.Contract(
                    AUCTION_ADDRESS, 
                    AUCTION_ABI, 
                    window.auctionApp.signer
                );
                log('‚úÖ Contract instance created');
                
                // Send transaction
                log('üì§ Sending transaction...');
                const ethValue = window.auctionApp.ethers.utils.parseEther(ethAmount);
                log(`üíé Parsed ETH value: ${ethValue.toString()}`);
                
                const tx = await contract.purchase({
                    value: ethValue,
                    gasLimit: 200000
                });
                
                log(`‚úÖ Transaction sent: ${tx.hash}`);
                showMessage('Transaction submitted! Waiting for confirmation...', 'info');
                
                // Wait for confirmation
                log('‚è≥ Waiting for confirmation...');
                const receipt = await tx.wait();
                
                log(`üéâ Transaction confirmed in block ${receipt.blockNumber}`);
                showMessage(`Purchase successful! Transaction: ${receipt.transactionHash}`, 'success');
                
                // Refresh auction data
                log('üîÑ Refreshing auction data...');
                await loadAuctionData();
                
                // Clear form
                document.getElementById('ethAmount').value = '';
                document.getElementById('arcxAmount').value = '';
                log('‚úÖ Purchase complete!');
                
            } catch (error) {
                log('‚ùå Purchase failed: ' + error.message);
                console.error('Full error object:', error);
                
                // Show the full error in debug
                if (error.data && error.data.message) {
                    log('ÔøΩ Contract error: ' + error.data.message);
                }
                if (error.reason) {
                    log('üí• Error reason: ' + error.reason);
                }
                if (error.code) {
                    log('üí• Error code: ' + error.code);
                }
                
                let errorMessage = 'Transaction failed: ' + error.message;
                if (error.message.includes('user rejected')) {
                    errorMessage = 'Transaction rejected by user';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage = 'Insufficient ETH balance';
                } else if (error.code === 'UNPREDICTABLE_GAS_LIMIT') {
                    errorMessage = 'Transaction would fail - check auction is still active';
                } else if (error.message.includes('auction has ended') || error.message.includes('not active')) {
                    errorMessage = 'Auction has ended';
                } else if (error.reason) {
                    errorMessage = 'Contract error: ' + error.reason;
                }
                
                showMessage(errorMessage, 'error');
            }
        }
        
        // Main initialization
        async function initialize() {
            try {
                updateStatus('LOADING', 'Loading Web3 libraries...');
                
                // Load ethers
                await loadEthers();
                
                updateStatus('LOADING', 'Connecting to Base network...');
                
                // Load auction data
                await loadAuctionData();
                
                // Set up event listeners
                document.getElementById('connectWallet').addEventListener('click', () => {
                    if (window.auctionApp.isConnected) {
                        location.reload();
                    } else {
                        connectWallet();
                    }
                });
                
                document.getElementById('ethAmount').addEventListener('input', () => {
                    const ethAmount = document.getElementById('ethAmount').value;
                    if (ethAmount && window.auctionApp.auctionData.currentPrice) {
                        try {
                            const ethValue = window.auctionApp.ethers.utils.parseEther(ethAmount);
                            const tokens = ethValue.mul(window.auctionApp.ethers.utils.parseEther('1')).div(window.auctionApp.auctionData.currentPrice);
                            document.getElementById('arcxAmount').value = parseInt(window.auctionApp.ethers.utils.formatEther(tokens)).toLocaleString();
                        } catch (error) {
                            document.getElementById('arcxAmount').value = 'Invalid';
                        }
                    }
                });
                
                // Set up purchase button
                document.getElementById('purchaseBtn').addEventListener('click', handlePurchase);
                
                // Set up auto-refresh
                setInterval(loadAuctionData, 30000);
                
                log('üéØ Initialization complete!');
                
            } catch (error) {
                log('‚ùå Initialization failed: ' + error.message);
                updateStatus('FAILED', 'Failed to initialize: ' + error.message, 'error');
            }
        }
        
        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
