<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCx Dutch Auction - Live Interface</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, #0a0a0f, #1a1a2e);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { text-align: center; margin-bottom: 40px; }
        .logo { font-size: 3rem; color: #00FF88; margin-bottom: 10px; }
        .subtitle { color: #888; font-size: 1.2rem; }
        
        .status-card {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .status-title { font-size: 1.5rem; color: #00FF88; margin-bottom: 15px; }
        .status-value { font-size: 4rem; font-weight: 700; margin: 20px 0; }
        .status-error { color: #ff4757; }
        .status-success { color: #00FF88; }
        .status-loading { color: #ffa502; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        
        .card {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            border-top: 2px solid #00FF88;
        }
        
        .card-title { color: #00FF88; font-size: 1.3rem; margin-bottom: 20px; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-item { text-align: center; padding: 15px; background: #16213e; border-radius: 8px; }
        .info-value { font-size: 1.5rem; font-weight: 600; color: white; }
        .info-label { color: #888; font-size: 0.9rem; margin-top: 5px; }
        
        .button {
            background: linear-gradient(45deg, #00FF88, #0052FF);
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .button:hover { transform: translateY(-2px); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .wallet-section {
            background: #16213e;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .wallet-status { display: flex; justify-content: space-between; align-items: center; }
        .wallet-info { display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #ff4757; }
        .status-dot.connected { background: #00FF88; }
        
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; margin-bottom: 8px; color: #00FF88; font-weight: 600; }
        .input-field {
            width: 100%;
            padding: 15px;
            background: #16213e;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            font-family: inherit;
        }
        .input-field:focus { outline: none; border-color: #00FF88; }
        
        .message-area { margin-top: 20px; }
        .message { padding: 15px; border-radius: 8px; margin: 10px 0; }
        .message.error { background: rgba(255, 71, 87, 0.1); border: 1px solid #ff4757; color: #ff4757; }
        .message.success { background: rgba(0, 255, 136, 0.1); border: 1px solid #00FF88; color: #00FF88; }
        .message.info { background: rgba(255, 165, 2, 0.1); border: 1px solid #ffa502; color: #ffa502; }
        
        .debug-info {
            background: #0d0d1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #888;
        }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
            .logo { font-size: 2rem; }
            .status-value { font-size: 2.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">ARCx</div>
            <div class="subtitle">Dutch Auction - Live Interface</div>
        </header>
        
        <div class="status-card">
            <div class="status-title">System Status</div>
            <div id="systemStatus" class="status-value status-loading">LOADING...</div>
            <div id="systemMessage">Initializing interface...</div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h2 class="card-title">Current Price</h2>
                <div style="text-align: center;">
                    <div id="currentPrice" style="font-size: 3rem; font-weight: 700; color: #00FF88; margin: 20px 0;">...</div>
                    <div style="color: #888;">ETH per ARCx</div>
                    <div style="color: #ffa502; font-size: 0.9rem; margin-top: 10px;">Price declining over time</div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">Auction Stats</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div id="tokensAvailable" class="info-value">...</div>
                        <div class="info-label">Available</div>
                    </div>
                    <div class="info-item">
                        <div id="tokensSold" class="info-value">...</div>
                        <div class="info-label">Sold</div>
                    </div>
                    <div class="info-item">
                        <div id="totalRaised" class="info-value">...</div>
                        <div class="info-label">ETH Raised</div>
                    </div>
                    <div class="info-item">
                        <div id="timeRemaining" class="info-value">...</div>
                        <div class="info-label">Time Left</div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
                <h2 class="card-title">Purchase Tokens</h2>
                
                <div class="wallet-section">
                    <div class="wallet-status">
                        <div class="wallet-info">
                            <div id="statusDot" class="status-dot"></div>
                            <div>
                                <div id="walletStatus">Not Connected</div>
                                <div id="walletAddress" style="font-size: 0.8rem; color: #888;"></div>
                            </div>
                        </div>
                        <button id="connectWallet" class="button">Connect Wallet</button>
                    </div>
                </div>
                
                <div id="purchaseForm">
                    <div class="input-group">
                        <label class="input-label">ETH Amount</label>
                        <input type="number" id="ethAmount" class="input-field" placeholder="0.1" step="0.001" min="0">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">ARCx Tokens (Estimated)</label>
                        <input type="text" id="arcxAmount" class="input-field" placeholder="0" readonly>
                    </div>
                    
                    <button id="purchaseBtn" class="button" disabled style="width: 100%;">
                        Connect Wallet to Purchase
                    </button>
                    
                    <div id="messageArea" class="message-area"></div>
                </div>
            </div>
        </div>
        
        <div class="debug-info">
            <div><strong>Debug Info:</strong></div>
            <div id="debugInfo">Starting initialization...</div>
        </div>
    </div>

    <!-- Load ethers with failsafe -->
    <script>
        // Global variables
        window.auctionApp = {
            ethers: null,
            provider: null,
            signer: null,
            contract: null,
            isConnected: false,
            auctionData: {}
        };
        
        const AUCTION_ADDRESS = "0x5Da5F567553C8D4F12542Ba608F41626f77Aa836";
        const BASE_CHAIN_ID = 8453;
        const AUCTION_ABI = [
            "function getAuctionStatus() view returns (uint256 _currentPrice, uint256 _tokensSold, uint256 _tokensRemaining, uint256 _totalRaised, uint256 _timeRemaining, bool _isActive)",
            "function purchase() payable"
        ];
        
        // Debug logging
        function log(message) {
            console.log(message);
            const debugEl = document.getElementById('debugInfo');
            if (debugEl) {
                debugEl.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
            }
        }
        
        // Update status display
        function updateStatus(status, message, type = 'loading') {
            const statusEl = document.getElementById('systemStatus');
            const messageEl = document.getElementById('systemMessage');
            
            if (statusEl) {
                statusEl.textContent = status;
                statusEl.className = `status-value status-${type}`;
            }
            if (messageEl) {
                messageEl.textContent = message;
            }
        }
        
        // Load ethers.js with multiple fallbacks
        function loadEthers() {
            return new Promise((resolve, reject) => {
                const cdnList = [
                    'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js',
                    'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js'
                ];
                
                let currentIndex = 0;
                
                function tryNext() {
                    if (currentIndex >= cdnList.length) {
                        reject(new Error('All CDN attempts failed'));
                        return;
                    }
                    
                    log(`Trying ethers CDN ${currentIndex + 1}/${cdnList.length}: ${cdnList[currentIndex]}`);
                    
                    const script = document.createElement('script');
                    script.src = cdnList[currentIndex];
                    
                    script.onload = () => {
                        setTimeout(() => {
                            if (typeof ethers !== 'undefined') {
                                window.auctionApp.ethers = ethers;
                                log(`‚úÖ Ethers loaded successfully from CDN ${currentIndex + 1}`);
                                resolve(ethers);
                            } else {
                                log(`‚ö†Ô∏è CDN ${currentIndex + 1} loaded but ethers not available`);
                                currentIndex++;
                                tryNext();
                            }
                        }, 100);
                    };
                    
                    script.onerror = () => {
                        log(`‚ùå CDN ${currentIndex + 1} failed to load`);
                        currentIndex++;
                        tryNext();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryNext();
            });
        }
        
        // Load auction data
        async function loadAuctionData() {
            try {
                log('Loading auction data...');
                const provider = new window.auctionApp.ethers.providers.JsonRpcProvider('https://mainnet.base.org');
                const contract = new window.auctionApp.ethers.Contract(AUCTION_ADDRESS, AUCTION_ABI, provider);
                
                const status = await contract.getAuctionStatus();
                
                window.auctionApp.auctionData = {
                    currentPrice: status._currentPrice,
                    tokensSold: status._tokensSold,
                    tokensRemaining: status._tokensRemaining,
                    totalRaised: status._totalRaised,
                    timeRemaining: status._timeRemaining,
                    isActive: status._isActive
                };
                
                // Update UI
                const price = parseFloat(window.auctionApp.ethers.utils.formatEther(status._currentPrice)).toFixed(6);
                const available = parseInt(window.auctionApp.ethers.utils.formatEther(status._tokensRemaining)).toLocaleString();
                const sold = parseInt(window.auctionApp.ethers.utils.formatEther(status._tokensSold)).toLocaleString();
                const raised = parseFloat(window.auctionApp.ethers.utils.formatEther(status._totalRaised)).toFixed(2);
                const timeLeft = formatTime(status._timeRemaining.toNumber());
                
                document.getElementById('currentPrice').textContent = price;
                document.getElementById('tokensAvailable').textContent = available;
                document.getElementById('tokensSold').textContent = sold;
                document.getElementById('totalRaised').textContent = raised;
                document.getElementById('timeRemaining').textContent = timeLeft;
                
                log('‚úÖ Auction data loaded successfully');
                updateStatus('READY', 'Auction interface ready', 'success');
                
            } catch (error) {
                log('‚ùå Error loading auction data: ' + error.message);
                updateStatus('ERROR', 'Failed to load auction data', 'error');
                
                document.getElementById('currentPrice').textContent = 'Error';
                document.getElementById('tokensAvailable').textContent = 'Error';
                document.getElementById('tokensSold').textContent = 'Error';
                document.getElementById('totalRaised').textContent = 'Error';
                document.getElementById('timeRemaining').textContent = 'Error';
            }
        }
        
        // Format time helper
        function formatTime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }
        
        // Wallet connection
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask not installed');
                }
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Switch to Base
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x2105' }]
                    });
                } catch (error) {
                    if (error.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x2105',
                                chainName: 'Base',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: ['https://mainnet.base.org'],
                                blockExplorerUrls: ['https://basescan.org']
                            }]
                        });
                    }
                }
                
                window.auctionApp.provider = new window.auctionApp.ethers.providers.Web3Provider(window.ethereum);
                window.auctionApp.signer = window.auctionApp.provider.getSigner();
                
                const address = await window.auctionApp.signer.getAddress();
                
                document.getElementById('walletStatus').textContent = 'Connected';
                document.getElementById('walletAddress').textContent = `${address.slice(0, 8)}...${address.slice(-6)}`;
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('connectWallet').textContent = 'Disconnect';
                document.getElementById('purchaseBtn').disabled = false;
                document.getElementById('purchaseBtn').textContent = 'Purchase ARCx';
                
                window.auctionApp.isConnected = true;
                log('‚úÖ Wallet connected successfully');
                
                // Enable purchase functionality
                if (window.auctionApp.auctionData.isActive) {
                    showMessage('Wallet connected! You can now purchase ARCx tokens.', 'success');
                }
                
            } catch (error) {
                log('‚ùå Wallet connection failed: ' + error.message);
                showMessage('Failed to connect wallet: ' + error.message, 'error');
            }
        }
        
        // Show message
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => messageArea.innerHTML = '', 5000);
            }
        }
        
        // Handle purchase
        async function handlePurchase() {
            try {
                if (!window.auctionApp.isConnected) {
                    showMessage('Please connect your wallet first', 'error');
                    return;
                }
                
                const ethAmount = document.getElementById('ethAmount').value;
                if (!ethAmount || parseFloat(ethAmount) <= 0) {
                    showMessage('Please enter a valid ETH amount', 'error');
                    return;
                }
                
                if (!window.auctionApp.auctionData.isActive) {
                    showMessage('Auction has ended', 'error');
                    return;
                }
                
                log('Starting purchase transaction...');
                showMessage('Initiating purchase...', 'info');
                
                // Create contract instance with signer
                const contract = new window.auctionApp.ethers.Contract(
                    AUCTION_ADDRESS, 
                    AUCTION_ABI, 
                    window.auctionApp.signer
                );
                
                // Send transaction
                const tx = await contract.purchase({
                    value: window.auctionApp.ethers.utils.parseEther(ethAmount),
                    gasLimit: 200000
                });
                
                log(`Transaction sent: ${tx.hash}`);
                showMessage('Transaction submitted! Waiting for confirmation...', 'info');
                
                // Wait for confirmation
                const receipt = await tx.wait();
                
                log(`Transaction confirmed in block ${receipt.blockNumber}`);
                showMessage(`Purchase successful! Transaction: ${receipt.transactionHash}`, 'success');
                
                // Refresh auction data
                await loadAuctionData();
                
                // Clear form
                document.getElementById('ethAmount').value = '';
                document.getElementById('arcxAmount').value = '';
                
            } catch (error) {
                log('‚ùå Purchase failed: ' + error.message);
                
                let errorMessage = 'Transaction failed';
                if (error.message.includes('user rejected')) {
                    errorMessage = 'Transaction rejected by user';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage = 'Insufficient ETH balance';
                } else if (error.code === 'UNPREDICTABLE_GAS_LIMIT') {
                    errorMessage = 'Transaction would fail - please check your inputs';
                } else if (error.message.includes('auction has ended') || error.message.includes('not active')) {
                    errorMessage = 'Auction has ended';
                }
                
                showMessage(errorMessage, 'error');
            }
        }
        
        // Main initialization
        async function initialize() {
            try {
                updateStatus('LOADING', 'Loading Web3 libraries...');
                
                // Load ethers
                await loadEthers();
                
                updateStatus('LOADING', 'Connecting to Base network...');
                
                // Load auction data
                await loadAuctionData();
                
                // Set up event listeners
                document.getElementById('connectWallet').addEventListener('click', () => {
                    if (window.auctionApp.isConnected) {
                        location.reload();
                    } else {
                        connectWallet();
                    }
                });
                
                document.getElementById('ethAmount').addEventListener('input', () => {
                    const ethAmount = document.getElementById('ethAmount').value;
                    if (ethAmount && window.auctionApp.auctionData.currentPrice) {
                        try {
                            const ethValue = window.auctionApp.ethers.utils.parseEther(ethAmount);
                            const tokens = ethValue.mul(window.auctionApp.ethers.utils.parseEther('1')).div(window.auctionApp.auctionData.currentPrice);
                            document.getElementById('arcxAmount').value = parseInt(window.auctionApp.ethers.utils.formatEther(tokens)).toLocaleString();
                        } catch (error) {
                            document.getElementById('arcxAmount').value = 'Invalid';
                        }
                    }
                });
                
                // Set up purchase button
                document.getElementById('purchaseBtn').addEventListener('click', handlePurchase);
                
                // Set up auto-refresh
                setInterval(loadAuctionData, 30000);
                
                log('üéØ Initialization complete!');
                
            } catch (error) {
                log('‚ùå Initialization failed: ' + error.message);
                updateStatus('FAILED', 'Failed to initialize: ' + error.message, 'error');
            }
        }
        
        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
